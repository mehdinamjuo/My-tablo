<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Magic Frame AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.4/dist/mindar-image-aframe.prod.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }

  /* فیکس کردن دوربین روی کل صفحه */
  #ar-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
  
  video {
    width: 100vw !important;
    height: 100vh !important;
    object-fit: cover !important;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
  }

  /* لودینگ سریع (نسخه 2) */
  #loader {
    position: fixed; inset: 0; background: #000;
    color: #00dbde; display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 1000;
  }
  .progress-bar { width: 60%; height: 2px; background: #222; margin-top: 10px; }
  .progress-fill { width: 0%; height: 100%; background: #00dbde; transition: width 0.1s; }

  /* استایل متن راهنما و FPS */
  #hint {
    position: fixed; bottom: 10%; left: 50%; transform: translateX(-50%);
    color: white; background: rgba(0,0,0,0.5); padding: 8px 16px;
    border-radius: 20px; font-family: sans-serif; pointer-events: none;
    opacity: 0; transition: opacity 0.3s; z-index: 100;
  }

  #stats {
    position: fixed; top: 10px; left: 10px; color: #00dbde;
    font-size: 10px; font-family: monospace; z-index: 100;
  }
</style>
</head>

<body>

<div id="loader">
  <div style="font-size: 14px; font-weight: bold;">LOADING AR</div>
  <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
</div>

<div id="stats">FPS: <span id="fpsVal">0</span></div>
<div id="hint">تابلو را شناسایی کنید</div>

<a-scene
  mindar-image="imageTargetSrc: targets.mind; uiScanning: false; uiLoading: false; filterMinCF:0.0001; filterBeta: 0.001;"
  embedded
  color-space="sRGB"
  renderer="antialias: false; precision: medium; alpha: true; powerPreference: high-performance"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets>
    <video id="vid" src="video.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline preload="auto"></video>
  </a-assets>

  <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

  <a-entity mindar-image-target="targetIndex: 0">
    <a-video src="#vid" width="1" height="0.6" position="0 0 0"></a-video>
  </a-entity>
</a-scene>

<script>
  const scene = document.querySelector("a-scene");
  const vid = document.getElementById("vid");
  const fill = document.getElementById("progressFill");
  const loader = document.getElementById("loader");
  const hint = document.getElementById("hint");
  const fpsVal = document.getElementById("fpsVal");

  // ۱. سیستم لودینگ سریع
  let prog = 0;
  const loadSim = setInterval(() => {
    prog += (100 - prog) * 0.1;
    fill.style.width = prog + "%";
  }, 100);

  // ۲. مدیریت FPS
  let frames = 0;
  let lastTime = performance.now();
  function tick() {
    frames++;
    const now = performance.now();
    if (now >= lastTime + 1000) {
      fpsVal.innerText = frames;
      frames = 0;
      lastTime = now;
    }
    requestAnimationFrame(tick);
  }
  tick();

  // ۳. رفع مشکل صفحه سیاه و اجرای AR
  scene.addEventListener("arReady", () => {
    clearInterval(loadSim);
    fill.style.width = "100%";
    setTimeout(() => {
      loader.style.display = "none";
      hint.style.opacity = "1";
    }, 300);
  });

  // ۴. کنترل ویدیو و راهنما
  scene.addEventListener("targetFound", () => {
    hint.style.opacity = "0";
    vid.play().catch(() => {
        // برای محدودیت‌های مرورگر
        const playOnTouch = () => { vid.play(); document.removeEventListener('touchstart', playOnTouch); };
        document.addEventListener('touchstart', playOnTouch);
    });
  });

  scene.addEventListener("targetLost", () => {
    vid.pause();
    hint.style.opacity = "1";
  });

  // ۵. مدیریت خطای احتمالی دوربین
  scene.addEventListener("arError", () => {
    alert("لطفاً اجازه دسترسی به دوربین را صادر کنید و صفحه را رفرش کنید.");
  });
</script>

</body>
</html>
