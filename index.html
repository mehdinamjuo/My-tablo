<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Magic Frame AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="تابلو متحرک AR - پخش خودکار ویدیو و صدا">
<meta name="theme-color" content="#000000">

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.4/dist/mindar-image-aframe.prod.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Vazirmatn', sans-serif; }

/* بهبود لودینگ برای سرعت بصری */
#loader {
  position: fixed; inset: 0;
  background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a0a 100%);
  color: white; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 10000; transition: opacity 0.4s ease-out;
}

.loader-content { text-align: center; width: 85%; }
#loader h1 { font-size: 1.6rem; margin-bottom: 10px; color: #00dbde; }

#progressBar {
  width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1);
  border-radius: 10px; margin: 20px 0; overflow: hidden;
}
#progressFill {
  height: 100%; width: 0%; background: #00dbde;
  box-shadow: 0 0 10px #00dbde; transition: width 0.2s;
}

/* راهنمای شناور */
#hint {
  position: fixed; bottom: 10%; left: 50%; transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8); color: #fff; padding: 12px 25px;
  border-radius: 30px; z-index: 999; opacity: 0;
  transition: all 0.3s; border: 1px solid #00dbde;
  pointer-events: none; white-space: nowrap;
}

/* نمایشگر وضعیت سیستم */
#systemInfo {
  position: fixed; top: 10px; right: 10px;
  background: rgba(0, 0, 0, 0.5); color: #00dbde;
  padding: 5px 10px; border-radius: 5px; font-size: 11px; z-index: 999;
}

.hidden { display: none !important; }
</style>
</head>

<body>

<div id="loader">
  <div class="loader-content">
    <h1>Magic Frame AR</h1>
    <div id="progressBar"><div id="progressFill"></div></div>
    <p id="loaderStatus" style="font-size: 0.8rem; color: #aaa;">در حال فراخوانی دوربین...</p>
  </div>
</div>

<div id="hint">تابلو را شناسایی کنید</div>
<div id="systemInfo">FPS: <span id="fps">--</span> | <span id="arStatus">Loading</span></div>

<a-scene
  mindar-image="imageTargetSrc: targets.mind; uiScanning: false; uiLoading: false; filterMinCF:0.0001; filterBeta: 0.001;"
  embedded color-space="sRGB"
  renderer="antialias: false; precision: medium; powerPreference: high-performance"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets>
    <video id="vid" src="video.mp4" 
           loop="true" crossorigin="anonymous" 
           playsinline webkit-playsinline 
           preload="auto"></video>
  </a-assets>

  <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

  <a-entity mindar-image-target="targetIndex: 0">
    <a-video src="#vid" width="1" height="0.6" position="0 0 0" rotation="0 0 0"></a-video>
  </a-entity>
</a-scene>

<script>
const scene = document.querySelector("a-scene");
const vid = document.getElementById("vid");
const loader = document.getElementById("loader");
const fill = document.getElementById("progressFill");
const status = document.getElementById("loaderStatus");
const hint = document.getElementById("hint");
const arStatusText = document.getElementById("arStatus");

// مدیریت لودینگ سریع
let progress = 0;
const interval = setInterval(() => {
    if(progress < 90) {
        progress += Math.random() * 15;
        fill.style.width = progress + "%";
    }
}, 200);

// وقتی سیستم AR کاملاً آماده شد
scene.addEventListener("arReady", () => {
    clearInterval(interval);
    fill.style.width = "100%";
    status.innerText = "آماده اسکن!";
    
    setTimeout(() => {
        loader.style.opacity = "0";
        setTimeout(() => loader.classList.add("hidden"), 500);
        hint.style.opacity = "1";
        arStatusText.innerText = "Ready";
    }, 400);
});

// شناسایی هدف
scene.addEventListener("targetFound", () => {
    hint.style.opacity = "0";
    arStatusText.innerText = "Streaming";
    
    // حل مشکل Autoplay در تمام گوشی‌ها
    const startVideo = () => {
        vid.play();
        document.removeEventListener('touchstart', startVideo);
    };
    
    vid.play().catch(() => {
        hint.innerText = "برای شروع صدا، صفحه را لمس کنید";
        hint.style.opacity = "1";
        document.addEventListener('touchstart', startVideo);
    });
});

// گم کردن هدف
scene.addEventListener("targetLost", () => {
    vid.pause();
    hint.innerText = "تابلو را مقابل دوربین بگیرید";
    hint.style.opacity = "1";
    arStatusText.innerText = "Searching...";
});

// بهینه‌سازی FPS
let frameCount = 0;
let lastTime = performance.now();
function updateFPS() {
    frameCount++;
    let now = performance.now();
    if (now - lastTime >= 1000) {
        document.getElementById("fps").innerText = frameCount;
        frameCount = 0;
        lastTime = now;
    }
    requestAnimationFrame(updateFPS);
}
updateFPS();

// جلوگیری از زوم ناخواسته در iOS
document.addEventListener('gesturestart', (e) => e.preventDefault());
</script>

</body>
</html>
